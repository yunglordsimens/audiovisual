<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Lab Unit</title>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: monospace; }
        canvas { display: block; }
    </style>
</head>
<body>
    <canvas id="c"></canvas>

    <script>
        // === LAB UNIT STANDARD TEMPLATE ===
        
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        // Начальное состояние
        let state = {
            text: "INIT...",
            params: { a: 0.5, b: 0.5, c: 0.1 },
            hue: 180
        };

        // Слушаем приказы из Лаборатории
        window.addEventListener('message', (e) => {
            if(e.data.type === 'UPDATE_STATE') {
                state = e.data;
                restartEffect();
            }
        });

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            restartEffect();
        }
        window.addEventListener('resize', resize);

        // === СПЕЦИФИЧНАЯ ЛОГИКА ЭТОГО ДЕМО (Pixel Storm) ===
        
        let particles = [];

        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.ox = x; this.oy = y;
                this.vx = 0; this.vy = 0;
            }
            update() {
                // Param A = Сила возврата
                // Param C = Хаос
                let chaos = state.params.c * 5;
                this.vx += (Math.random() - 0.5) * chaos;
                this.vy += (Math.random() - 0.5) * chaos;
                
                let dx = this.ox - this.x;
                let dy = this.oy - this.y;
                let speed = 0.01 + (state.params.a * 0.1);

                this.vx += dx * speed;
                this.vy += dy * speed;
                this.vx *= 0.9;
                this.vy *= 0.9;
                this.x += this.vx;
                this.y += this.vy;
            }
            draw() {
                // Param B = Размер
                let s = 1 + state.params.b * 4;
                ctx.fillStyle = `hsl(${state.hue}, 100%, 50%)`;
                ctx.fillRect(this.x, this.y, s, s);
            }
        }

        function restartEffect() {
            particles = [];
            
            // Рисуем текст для сканирования
            ctx.clearRect(0,0,canvas.width,canvas.height);
            // Адаптивный шрифт
            let fontSize = Math.min(canvas.width, canvas.height) * 0.2;
            ctx.font = `bold ${fontSize}px monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.fillText(state.text, canvas.width/2, canvas.height/2);

            // Сканируем
            const idata = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = idata.data;
            ctx.clearRect(0,0,canvas.width,canvas.height);

            // Оптимизация шага
            let step = 6; 
            if (window.innerWidth > 1000) step = 5;

            for(let y=0; y<canvas.height; y+=step) {
                for(let x=0; x<canvas.width; x+=step) {
                    if(data[(y*canvas.width+x)*4+3] > 128) {
                        particles.push(new Particle(x, y));
                    }
                }
            }
        }

        function animate() {
            // Делаем фон чуть прозрачным для шлейфа, если хотим
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            // Если это фон (background-iframe), можно рисовать тусклее
            // Но пока рисуем одинаково
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }

        resize();
        animate();
    </script>
</body>
</html>